<script>
	$(function() {		
		var selectList = $("#currencySelectorForm select");
		$($(selectList[0]).find('option')[0]).attr('selected','selected');
		$($(selectList[1]).find('option')[0]).attr('disabled','disabled');
		$($(selectList[1]).find('option')[1]).attr('selected','selected');
		
		$(".rateCtrlBtn").attr('disabled','disabled');
		
		$("#currencySelectorForm select").on('change',function(){
			var current=0,target=1;
			if(selectList[1] == $(this).get(0)){
				current = 1;target = 0;
			}
			$(selectList[current]).find('option').removeAttr('disabled');
			$(selectList[target]).find('option').removeAttr('disabled');
			$(selectList[target]).find('option[value="'+$(this).find("option:selected").val()+'"]').attr('disabled','disabled');
			
			$(".rateEditorContainer").html('');
			$(".rateCtrlBtn").attr('disabled','disabled');
		});
				
		$("#currencySelectorForm").submit(function(){
			var $self = $(this);
			var jqXHR = $.ajax({
				url:"{{prefix}}/priceeditor",
				data:$self.serialize(),
				dataType:"html"
			});
			jqXHR.done(function(data){
				$(".rateEditorContainer").html(data);
				$(".add.rateCtrlBtn").removeAttr('disabled');
			});
			return false;
		});		
		
		$(document).on('click',"#rateTable tbody tr",function(){
			$("#rateTable tbody tr").removeClass('selected');
			$(this).addClass('selected');
			$(".edit.rateCtrlBtn,.delete.rateCtrlBtn").removeAttr('disabled');
		});
		
		$(".add.rateCtrlBtn,.edit.rateCtrlBtn").click(function(){
			var title = 'Add Rate Currency';
			var mode = 'add';
			var id = 0;
			if($(this).hasClass('edit')){
				title = 'Edit Rate Currency';
				mode = 'edit';
				id = $("#rateTable tr.selected").data('id');
				$("#rate").val($("#rateTable tr.selected td.rate").text());
				$("#date").val($("#rateTable tr.selected td.date").text());
			}
			var $dialog = $("#dialogRateCurrency");
			$dialog.dialog("destroy");
			$dialog.attr('data-mode',mode).removeClass('invisible').dialog({
				title:title,
				position:'center',
				buttons: {
					"apply": function() {
						var date = $("#date").val();
						var rate = $("#rate").val();
						var from = $("#from").val();
						var to = $("#to").val();
						var jqXHR = $.ajax({
							url:"{{prefix}}/priceeditor",
							data:{mode:mode,date:date,value:rate,from:from,to:to,id:id},
							dataType:"html"
						});
						jqXHR.done(function(data){
							if(id != 0){								
								$("#rateTable tr.selected[data-id='"+id+"']").replaceWith(data);
							}
							else{
								$("#rateTable tbody").append(data);
							}
							$dialog.dialog("close");
						});											
					},			
					close: function() {
						$dialog.dialog("close");					
					}
				},							
				autoOpen: true,
				resizable: false,
				height: 280,
				width: 300,
				modal: true,
				draggable: false
			});	
			$("#dialogRateCurrency #date").datepicker();
			return false;
		});
		$(".delete.rateCtrlBtn").click(function(){
			var id = $("#rateTable tr.selected").data('id');
			var $dialog =$ ("#dialogRateCurrency-delete");
			$dialog.dialog("destroy");
			$dialog.removeClass('invisible').dialog({				
				resizable: false,
				height:140,
				modal: true,
				buttons: {
					"Delete": function() {
						var jqXHR = $.ajax({
							url:"{{prefix}}/priceeditor",
							data:{deleteId:id},
							dataType:"json"								
						});
						jqXHR.done(function(data){
							if(!data.error){
								$("#rateTable tr.selected[data-id='"+id+"']").remove();
							}							
							$dialog.dialog("close");
						});						
					},
					Cancel: function() {
						$dialog.dialog( "close" );
					}
				}
			});
		});
		
	});
</script>
<div class="header"><h2>{{#i18n}}Select pair of currencies to edit rate exchanging currency{{/i18n}}</h2></div>
<form id="currencySelectorForm">
	
	<select id="firstCurrency" name="firstCurr">
		{{#currencies}}
			<option value="{{iso}}">{{iso}} - {{country}}</option>
		{{/currencies}}
	</select>
	
	
	<select id="secondCurrency" name="secondCurr">
		{{#currencies}}
			<option value="{{iso}}">{{iso}} - {{country}}</option>
		{{/currencies}}
	</select>
	
	<button type="submit" class="action-button">{{#i18n}}Apply{{/i18n}}</button>
</form>
<div class="rateCtrlButtonsContainer">
	<button class="add rateCtrlBtn" disabled="disabled" >{{#i18n}}Add{{/i18n}}</button>
	<button class="edit rateCtrlBtn" disabled="disabled" >{{#i18n}}Edit{{/i18n}}</button>
	<button class="delete rateCtrlBtn" disabled="disabled" >{{#i18n}}Delete{{/i18n}}</button>
</div>
<div class="rateEditorContainer">

</div>


