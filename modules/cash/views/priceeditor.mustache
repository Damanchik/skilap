<script type="text/javascript" src="{{prefix}}/js/highcharts/highcharts.js"></script>
<script type="text/javascript">	
	$(function() {	
		var graphOptions = {
            chart: {
                renderTo: 'graphContainer',
                zoomType: 'x',
                spacingRight: 20
            },
            title: {
                text: ''
            },
            subtitle: {
                text: document.ontouchstart === undefined ?
                    '{{#i18n}}Click and drag in the plot area to zoom in{{/i18n}}' :
                    '{{#i18n}}Drag your finger over the plot to zoom in{{/i18n}}'
            },
            xAxis: {
                type: 'datetime',
                maxZoom: 14 * 24 * 3600000, // fourteen days
                title: {
                    text: null
                }
            },
            yAxis: {
                title: {
                    text: '{{#i18n}}Exchange rate{{/i18n}}'
                },                
                startOnTick: false,                                
                showFirstLabel: false
            },
            tooltip: {
                shared: true
            },
            legend: {
                enabled: false
            },
            plotOptions: {
                area: {
                    fillColor: {
                        linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1},
                        stops: [
                            [0, Highcharts.getOptions().colors[0]],
                            [1, 'rgba(2,0,0,0)']
                        ]
                    },
                    lineWidth: 1,
                    marker: {
                        enabled: false,
                        states: {
                            hover: {
                                enabled: true,
                                radius: 5
                            }
                        }
                    },
                    shadow: false,
                    states: {
                        hover: {
                            lineWidth: 1
                        }
                    }
                }
            },
    
            series: [{
                type: 'area',
                name: '',                 
                data: []
            }]
        };
		
		var redrawPriceGraph = function(){
			var from =$("#currencySelectorForm").find('#firstCurrency option:selected').val();
			var to = $("#currencySelectorForm").find('#secondCurrency option:selected').val();
			var jqXHR = $.ajax({
				url:"{{prefix}}/priceeditor",
				data:{redrawGraph:1,from:from,to:to},
				dataType:"json"
			});
			jqXHR.done(function(res){	
				graphOptions.title.text = from+' {{#i18n}}to{{/i18n}} '+to+' {{#i18n}}exchange rate{{/i18n}}';
				graphOptions.series[0].name = from+' to '+to;	
				graphOptions.yAxis.max = res.max;			
				graphOptions.series[0].data = res.data;
				var chart = new Highcharts.Chart(graphOptions);				
			});
		};
		
		var selectList = $("#currencySelectorForm select");
		$($(selectList[0]).find('option')[0]).attr('selected','selected');
		$($(selectList[0]).find('option')[1]).attr('disabled','disabled');
		$($(selectList[1]).find('option')[0]).attr('disabled','disabled');
		$($(selectList[1]).find('option')[1]).attr('selected','selected');
		
		$(".rateCtrlBtn").attr('disabled','disabled');
		/* on change currency */
		$("#currencySelectorForm select").on('change',function(){
			var current=0,target=1;
			if(selectList[1] == $(this).get(0)){
				current = 1;target = 0;
			}
			$(selectList[current]).find('option').removeAttr('disabled');
			$(selectList[target]).find('option').removeAttr('disabled');
			var $currentOption = $(this).find("option:selected");
			var $targetOption = $(selectList[target]).find('option[value="'+$currentOption.val()+'"]');
			if($targetOption.is(":selected")){
				$targetOption.removeAttr('selected');
			}
			$targetOption.attr('disabled','disabled');
			
			$(".rateEditorContainer").html('');
			$("#graphContainer").html('');
			$(".rateCtrlBtn").attr('disabled','disabled');
		});
		
		var oldFrom,oldTo;				
		$("#currencySelectorForm").submit(function(){
			var $self = $(this);
			var from = $self.find('#firstCurrency option:selected').val();
			var to = $self.find('#secondCurrency option:selected').val();
			
			var jqXHR = $.ajax({
				url:"{{prefix}}/priceeditor",
				data:$self.serialize(),
				dataType:"html"
			});
			jqXHR.done(function(data){
				$("#dialogRateCurrency").dialog("destroy");
				$(".rateEditorContainer").html(data);
				$(".rateCtrlBtn").attr('disabled','disabled');
				$(".add.rateCtrlBtn").removeAttr('disabled');				
				if(oldFrom != from || oldTo != to){				
					oldFrom = from;
					oldTo = to;
					redrawPriceGraph();
				}
			});
			return false;
		});
		
		$(document).on('click',".pagination .pageNum",function(){
			if($(this).parent().hasClass("active"))
				return false;
			$("#currencySelectorForm input[name=\"offset\"]").val($(this).data("offset"));
			$("#currencySelectorForm").submit();
		});		
		
		$(document).on('click',"#rateTable tbody tr",function(){
			$("#rateTable tbody tr").removeClass('selected');
			$(this).addClass('selected');
			$(".edit.rateCtrlBtn,.delete.rateCtrlBtn").removeAttr('disabled');
		});
		
		$(".add.rateCtrlBtn,.edit.rateCtrlBtn").click(function(){
			var title,mode;
			var id = 0;
			if($(this).hasClass('add')){
				title = '{{#i18n}}Add Rate Currency{{/i18n}}';
				var mode = 'add';	
				$("#rate").val($("#rate").data("value"));
				$("#date").val($("#date").data("value"));			
			}
			else if($(this).hasClass('edit')){
				title = '{{#i18n}}Edit Rate Currency{{/i18n}}';
				mode = 'edit';
				id = $("#rateTable tr.selected").data('id');
				$("#rate").val($("#rateTable tr.selected td.rate").text());
				$("#date").val($("#rateTable tr.selected td.date").text());
			}
			var $dialog = $("#dialogRateCurrency");			
			$dialog.attr('data-mode',mode).removeClass('invisible').dialog({
				title:title,
				position:'center',
				buttons: {
					"{{#i18n}}Apply{{/i18n}}": function() {						
						var date = $(this).find("#date").val();
						var rate =  $(this).find("#rate").val();
						var from =  $(this).find("#from").val();
						var to =  $(this).find("#to").val();
						var jqXHR = $.ajax({
							url:"{{prefix}}/priceeditor",
							data:{mode:mode,date:date,value:rate,from:from,to:to,id:id},
							dataType:"html"
						});
						jqXHR.done(function(data){
							if(id != 0){								
								$("#rateTable tr.selected[data-id='"+id+"']").replaceWith(data);
							}
							else{
								$("#rateTable tbody").prepend(data);
							}
							$dialog.dialog("close");
							redrawPriceGraph();
						});											
					},			
					"{{#i18n}}Close{{/i18n}}": function() {
						$dialog.dialog("close");					
					}
				},							
				autoOpen: true,
				resizable: false,
				height: 280,
				width: 300,
				modal: true,
				draggable: false
			});	
			$("#dialogRateCurrency #date").datepicker();
			return false;
		});
		$(".delete.rateCtrlBtn").click(function(){
			var id = $("#rateTable tr.selected").data('id');
			var $dialog =$ ("#dialogRateCurrency-delete");
			$dialog.dialog("destroy");
			$dialog.removeClass('invisible').dialog({				
				resizable: false,
				height:140,
				modal: true,
				buttons: {
					"{{#i18n}}Delete{{/i18n}}": function() {
						var jqXHR = $.ajax({
							url:"{{prefix}}/priceeditor",
							data:{deleteId:id},
							dataType:"json"								
						});
						jqXHR.done(function(data){
							if(!data.error){
								$("#rateTable tr.selected[data-id='"+id+"']").remove();
							}							
							$dialog.dialog("close");
							redrawPriceGraph();
						});						
					},
					"{{#i18n}}Cancel{{/i18n}}": function() {
						$dialog.dialog( "close" );
					}
				}
			});
		});		
	});
</script>
<h2>{{#i18n}}Select pair of currencies to edit rate exchanging currency{{/i18n}}</h2>
<form id="currencySelectorForm" class="well form-inline">	
	<input type="hidden" name="offset" value="0" />
	<select id="firstCurrency" name="firstCurr">
		{{>currencies_list}}		
	</select>	
	
	<select id="secondCurrency" name="secondCurr">
		{{>currencies_list}}	
	</select>	
	<button type="submit" class="btn btn-primary">{{#i18n}}Apply{{/i18n}}</button>
</form>
<div class="row">
<div class="span4">	
	<div class="btn-group">
		<button class="btn add rateCtrlBtn" disabled="disabled" >{{#i18n}}Add{{/i18n}}</button>
		<button class="btn edit rateCtrlBtn" disabled="disabled" >{{#i18n}}Edit{{/i18n}}</button>
		<button class="btn delete rateCtrlBtn" disabled="disabled" >{{#i18n}}Delete{{/i18n}}</button>
    </div>	
	<div class="rateEditorContainer">

	</div>
</div>
<div class="span5">
	<div id="graphContainer"></div>
</div>
</div>


