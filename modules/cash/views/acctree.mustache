<script>
$(function() {
	$('#acc_parent option').filter('[pid="0"]').each(function(e) {
		$(this).text($.trim($(this).text()));
	});
	$('div.tree div:has(div)').addClass('parent');
	$('div.tree div').on("click", function(e) {
		var obj = $(this);
		obj.children('div').toggle();
		obj.filter('.parent').toggleClass('expanded');
		return false;
	});
	$('div.tree div a').on("click", function(e) {
		location.href=this.href;
		return false;
	});
	$('.editAcc').on("click", function(e){
		var self = $(this);
		var types = {{{types}}};
		var curency = {{{curencyStr}}};
		var form = document.forms.properties;
		form.elements.acc_id.value = self.attr('aid');
		var secret = form.elements.token.value;
		var json = {
				"jsonrpc": "2.0",
				"method": "cash.getAccount",
				"params": [secret, self.attr('aid') ],
				"id":1
			};
		var jqXHR = $.ajax({
				"type": "POST",
				"data": {json: JSON.stringify(json)},
				"dataType": "json",
				"url": "/jsonrpc",
			});
		jqXHR.done(function(data){
			var acc = data.result[0];
			form.elements.acc_name.value = acc.name;
			opts = form.elements.acc_parent.options;
			for (var i=0; i<opts.length; i++) {
				if (opts[i].value == acc.parentId){
					opts.selectedIndex=i;
				}
			}
			for (var i=0; i<types.length; i++) {
				if (types[i].value == acc.type) form.elements.acc_type.selectedIndex = i;
			}
			for (var i=0; i<curency.length; i++) {
				if (curency[i].iso == acc.cmdty.id) form.elements.acc_curency.selectedIndex = i;
			}
		});
		jqXHR.fail(function(data){
		});
		$("#dialog").dialog("open");
		return false;
	});
	$("#dialog").dialog({
		position: ["center","center"],
		buttons: {
			"apply": function() {
				var f = document.forms.properties;
				var params = {
						id: f.elements.acc_id.value,
						name: f.elements.acc_name.value,
						parentId: f.elements.acc_parent.options[f.elements.acc_parent.selectedIndex].value,
						curency: f.elements.acc_curency.options[f.elements.acc_curency.selectedIndex].value,
						type: f.elements.acc_type.options[f.elements.acc_type.selectedIndex].value
					};
				var jqXHR = $.ajax({
					"type": "POST",
					"data": params,
					"dataType": "json",
					"url": "{{prefix}}/accupd",
				});
				jqXHR.done(function(data){
					var curent = $('#'+data.id);
					$('#open'+data.id).text(data.name);
					var parent;
					if (data.parentId == 0) {
						parent = $('#tree_root');
						parent.append(curent);
					} else {
						parent = $('#'+data.parentId);
						parent.addClass('expanded');
						parent.children('div').show();
						parent.append(curent);
					}
				});
				jqXHR.fail(function(data){
				});
				$(this).dialog("close");
			},
			"close": function() {
				$(this).dialog("close");
			}
		},
		autoOpen: false,
		resizable: false,
		height: 270,
		width: 450,
		modal: true,
		draggable: false
	});
});
</script>

<div id="dialog" title="Report settings" style="width: 600; height: 200px;">
	<form name="properties">
		<input type="hidden" id="acc_id">
		<input type="hidden" id="token" value="{{token}}">
		<table>
			<tr>
				<td>Name:</td>
				<td><input type="text" id="acc_name"></tr>
			</tr>
			<tr>
				<td>Parent account:</td>
				<td>
					<select name="acc_parent" id="acc_parent">
						<option value="0" pid="0">Root</option>
						{{#assets}}
							{{>acctree_list_item}}
						{{/assets}}
					</select>
				</td>
			</tr>
			<tr>
				<td>Curency:</td>
				<td>
					<select name="acc_curency" id="acc_curency">
						{{#curencies}}
							<option value="{{iso}}">{{iso}} - {{country}}</option>
						{{/curencies}}
					</select>
				</td>
			</tr>
			<tr>
				<td>Type:</td>
				<td>
					<select name="acc_type" id="accType">
						{{#assetsTypes}}
							<option value="{{value}}">{{name}}</option>
						{{/assetsTypes}}
					</select>
				</td>
			</tr>
		</table>
	</form>
</div>

<div id="home">
	<div id="tree_root" class="main tree">
	{{#assets}}
		{{>acctree_item}}
	{{/assets}}
	</div>
</div>
