<script type="text/javascript">
$(function() {	
	$("#dialog").dialog({
		position: ["left","top"],
		buttons: {
			"{{#i18n}}Apply{{/i18n}}": function() {
				var slots = [];
 				$('.slot:checked').each(function (i, input) {
					slots.push({"key": $(input).attr("id"), "value": "true"});
				});
				var params = {
						id: $('#acc_id').val(),
						name: $('#acc_name').val(),
						parentId: $('#acc_parent option:selected').val(),
						curency: $('#acc_curency option:selected').val(),
						type: $('#acc_type option:selected').val(),
						slots: slots
					};
				var jqXHR = $.ajax({
					"type": "POST",
					"data": params,
					"dataType": "json",
					"url": "{{prefix}}/accupd",
				});
				jqXHR.done(function(data){
					window.parent.$("body").trigger('accountUpdatedSuccess',[data]);					
				});
				jqXHR.fail(function(data){
					window.parent.$("body").trigger('accountUpdatedFailed');
				});
				//$(this).dialog("close");
				window.parent.$("body .iframeContainer").trigger('closeDialog');
			},			
			"{{#i18n}}Close{{/i18n}}": function() {
				//$(this).dialog("close");
				//console.log('closeDialog');
				window.parent.$("body .iframeContainer").trigger('closeDialog');
			}
		},
		open:function(e,ui){			
			var w = $(this).parent().width();
			var h = $(this).parent().height();
			var p = $(this).parent().position();
			$(this).parent().css({"top":0,"left":0,"padding":0,"border":0});
			window.parent.$("body .iframeContainer-ski_createAccount").trigger('openDialog',[w,h,p]);						
		},
		close:function(e,ui){
			window.parent.$("body .iframeContainer").trigger('closeDialog');
		},
		autoOpen: true,
		resizable: false,
		height: 320,
		width: 500,
		modal: true,
		dragable: true
	});	
	
	function displayMessage(event){		
		if (event.origin === "https://{{host}}") {		
			if(event.data.name == 'setAccountDialogData'){									
				var acc = event.data.data;
				if(acc.id){			
					$('#acc_id').val(acc.id);
				}
				if(acc.name){
					$('#acc_name').val(acc.name);
				}
				if(acc.parentId){
					$('#acc_parent option[value='+acc.parentId+']').attr('selected', 'selected');
				}
				if(acc.type){
					$('#acc_type option[value="'+acc.type+'"]').attr('selected', 'selected');
				}
				if(acc.cmdty){
					$('#acc_curency option[value="'+acc.cmdty.id+'"]').attr('selected', 'selected');
				}
				if(acc.hidden){
					$('#hidden').attr('checked', 'checked');
				}
				if(acc.placeholder){
					$('#placeholder').attr('checked', 'checked');
				}
			}
			else if(event.data.name == 'resetAccountDialogData'){				
				$("#dialog form[name='properties']").get(0).reset();
			}			
		}		
	}
	
	if (window.addEventListener) {	
		window.addEventListener("message", displayMessage, false);
	}
	else {
		window.attachEvent("onmessage", displayMessage);
	}

});
</script>
<div id="dialog" title="{{#i18n}}Account properties{{/i18n}}" style="width: 500px; height: 300px;">
	<form name="properties">
		<input type="hidden" id="acc_id">
		<input type="hidden" id="token" value="{{token}}">
		<table>
			<tr>
				<td>{{#i18n}}Name{{/i18n}}:</td>
				<td><input type="text" id="acc_name"></tr>
			</tr>
			<tr>
				<td>{{#i18n}}Parent account{{/i18n}}:</td>
				<td>
					<select name="acc_parent" id="acc_parent">
						<option value="0" pid="0">{{#i18n}}Root{{/i18n}}</option>
						{{#assets}}
							{{>acctree_list_item}}
						{{/assets}}
					</select>
				</td>
			</tr>
			<tr>
				<td>{{#i18n}}Curency{{/i18n}}:</td>
				<td>
					<select name="acc_curency" id="acc_curency">
						{{>currencies_list}}
					</select>
				</td>
			</tr>
			<tr>
				<td>{{#i18n}}Type{{/i18n}}:</td>
				<td>
					<select name="acc_type" id="acc_type">
						{{#assetsTypes}}
							<option value="{{value}}">{{name}}</option>
						{{/assetsTypes}}
					</select>
				</td>
			</tr>
			<tr>
				<td>{{#i18n}}Hidden{{/i18n}}</td><td><input id="hidden" class="slot" type="checkbox" /></td>
			</tr>
			<tr>
				<td>{{#i18n}}Placeholder{{/i18n}}</td><td><input id="placeholder" class="slot" type="checkbox"></td>
			</tr>
		</table>
	</form>
</div>
